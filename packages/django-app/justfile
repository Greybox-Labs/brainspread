default:
  @just --list

# Execute django-admin commands in web container with database safety checks
django-admin +ARGS:
  #!/usr/bin/env bash
  set -euo pipefail
  
  # Check database environment
  DB_HOST_ENVAR=$(docker-compose run --rm -w /code/app web env | grep POSTGRES_HOST)
  DB_HOST=$(cut -d "=" -f2 <<< "$DB_HOST_ENVAR")
  # Trim newline
  DB_HOST=${DB_HOST//[$'\t\r\n']}
  
  if [ "$DB_HOST" != 'db' ] && [ "$DB_HOST" != '0.0.0.0' ] && [ "$DB_HOST" != 'localhost' ]; then
    echo "You are running this command against the database at ${DB_HOST}!"
    read -r -p "Are you sure you want to continue? [y/N] " response
    if [[ ! "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
      exit 1
    fi
  else
    echo "Running command against database at $DB_HOST..."
  fi
  
  docker-compose run --rm -w /code/app web /code/app/manage.py {{ARGS}}

# Execute shell commands in running web container
exec +ARGS:
  docker-compose exec web {{ARGS}}

# Generate Django secret key
generate-secret-key:
  docker-compose run --rm -w /code/app web python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'

# Run tests in web container
test:
  docker-compose run --rm -w /code/app web pytest -m "not integration" --cov=. --verbose

# Run shell commands in new web container
run +ARGS:
  docker-compose run --rm web {{ARGS}}

# Create Docker volumes
create-volumes:
  docker volume create --name=brainspread_postgres

# Dump database data to stdout
dump-data:
  docker-compose run --rm -w /code/app web /code/app/manage.py dumpdata \
    --natural-primary \
    --natural-foreign \
    --exclude=admin.logentry \
    --exclude=sessions.session \
    --indent 4

# Reload database with optional data fixture (defaults to dev_data.json)
reload-db DATA="dev_data.json":
  #!/usr/bin/env bash
  set -euo pipefail
  
  # Check database environment
  DB_HOST_ENVAR=$(docker-compose run --rm -w /code/app web env | grep POSTGRES_HOST)
  DB_HOST=$(cut -d "=" -f2 <<< "$DB_HOST_ENVAR")
  # Trim newline
  DB_HOST=${DB_HOST//[$'\t\r\n']}
  
  if [ "$DB_HOST" != 'db' ] && [ "$DB_HOST" != '0.0.0.0' ] && [ "$DB_HOST" != 'localhost' ]; then
    echo "You are trying to reload the database at ${DB_HOST}!"
    read -r -p "Are you sure you want to continue? [y/N] " response
    if [[ ! "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
      exit 1
    fi
  else
    echo "Reloading database at $DB_HOST"
  fi
  
  echo "starting script ..."
  echo "Reloading $DB_HOST w/ {{DATA}} ..."
  echo ""
  
  echo "recreating volume and container ..."
  # Stop and remove db container
  docker-compose stop db
  docker-compose rm -f db
  
  # Remove and recreate postgres volume
  docker volume rm brainspread_postgres || true
  docker volume create --name=brainspread_postgres
  
  # Bring container back up and wait for db
  docker-compose up -d db
  sleep 5
  
  echo "running migrations ..."
  docker-compose run --rm -w /code/app web /code/app/manage.py migrate
  
  echo "loading data from {{DATA}} ..."
  docker-compose run --rm -w /code/app web /code/app/manage.py loaddata {{DATA}}


# Common Django management commands shortcuts
migrate:
  just django-admin migrate

makemigrations:
  just django-admin makemigrations

shell:
  just django-admin shell

collectstatic:
  just django-admin collectstatic --noinput

# Start development server
runserver:
  just django-admin runserver 0.0.0.0:8000

# Database shortcuts
dbshell:
  just django-admin dbshell

# Load specific fixture
loaddata FIXTURE:
  just django-admin loaddata {{FIXTURE}}

# Show migrations status
showmigrations:
  just django-admin showmigrations

# Docker compose shortcuts
up:
  docker-compose up

up-d:
  docker-compose up -d

down:
  docker-compose down

build:
  docker-compose build

logs SERVICE="":
  @if [ -z "{{SERVICE}}" ]; then \
    docker-compose logs -f; \
  else \
    docker-compose logs -f {{SERVICE}}; \
  fi

# Show container status
ps:
  docker-compose ps

# Clean up project Docker resources
dcp-cleanup:
  docker-compose stop
  docker-compose rm -f db web
  docker volume rm brainspread_postgres

# Setup local Python virtual environment
setup-local-python-venv:
  python3 -m venv .venv
  source .venv/bin/activate
  PIPENV_VENV_IN_PROJECT=1 pipenv install --dev --deploy

# Copy environment template file
copy-env:
  cp .env.template .env

# Create Django superuser
create-superuser:
  just django-admin createsuperuser

default_backups_location := "./backups"

# Create backup with pgdump
create-pgdump location=default_backups_location:
  #!/usr/bin/env bash
  set -euo pipefail
  mkdir -p {{location}}
  docker-compose exec db pg_dump -U $POSTGRES_USER $POSTGRES_DB > {{location}}/`date +%Y-%m-%d_%H-%M-%S`-brainspread-dump.sql

# Create JSON backup of the database
create-json-backup location=default_backups_location:
  #!/usr/bin/env bash
  set -euo pipefail
  mkdir -p {{location}}
  just dump-data > {{location}}/`date +%Y-%m-%d_%H-%M-%S`-brainspread-dump.json

# Format Python code
format:
  docker-compose run --rm -w /code/app web bash -c "find . -name '*.py' -type f -not -path '*/migrations/*' | xargs autopep8 --in-place --aggressive --aggressive"

# Initialize project - create volumes, build images, setup database
init:
  just create-volumes
  just build
  just up-d db
  sleep 5
  just migrate
  echo "Project initialized! Run 'just copy-env' and add your SECRET_KEY, then 'just create-superuser' to get started."
